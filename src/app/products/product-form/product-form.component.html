<!-- src/app/products/product-form/product-form.component.html -->

<mat-card class="form-card">
  <mat-card-header>
    <mat-card-title>
      {{ isEdit ? 'Editar Producto' : 'Nuevo Producto' }}
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="save()">
      <!-- 1) Fila: Descripción  | Costo Compra -->
      <div class="row">
        <!-- Descripción -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Descripción *</mat-label>
          <textarea
            matInput
            formControlName="descripcion"
            rows="2"
          ></textarea>
          <mat-error *ngIf="descripcionCtrl?.hasError('required')">
            La descripción es obligatoria.
          </mat-error>
          <mat-error *ngIf="descripcionCtrl?.hasError('minlength')">
            Debe tener al menos 3 caracteres.
          </mat-error>
        </mat-form-field>

        <!-- Costo Compra (DECIMAL) -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Costo Compra *</mat-label>
          <input
            matInput
            formControlName="costoCompra"
            placeholder="0.00"
            (blur)="onBlurFormatDecimal('costoCompra')"
            (focus)="onFocusRawDecimal('costoCompra')"
          />
          <mat-error *ngIf="costoCompraCtrl?.hasError('required')">
            El costo es obligatorio.
          </mat-error>
          <mat-error *ngIf="costoCompraCtrl?.hasError('invalidDecimal')">
            Ingresa un número válido (máx. dos decimales).
          </mat-error>
        </mat-form-field>
      </div>

      <!-- 2) Fila: Estado | Existencia (ENTERO) -->
      <div class="row">
        <!-- Estado (Activo / Inactivo) -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Estado *</mat-label>
          <mat-select formControlName="estado">
            <mat-option [value]="1">Activo</mat-option>
            <mat-option [value]="0">Inactivo</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Existencia (ENTERO) -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Existencia *</mat-label>
          <input
            matInput
            formControlName="existencia"
            placeholder="0"
            (blur)="onBlurFormatInteger('existencia')"
            (focus)="onFocusRawInteger('existencia')"
          />
          <mat-error *ngIf="existenciaCtrl?.hasError('required')">
            La existencia es obligatoria.
          </mat-error>
          <mat-error *ngIf="existenciaCtrl?.hasError('invalidInteger')">
            Ingresa un entero válido (sin decimales).
          </mat-error>
        </mat-form-field>
      </div>

      <!-- 3) Fila: Categoría ID (ENTERO) | Precio Venta Actual (DECIMAL) -->
      <div class="row">
        <!-- Categoría ID -->
        <!-- Categoría ID (sin formateo con comas) -->
       <mat-form-field appearance="fill" class="form-field">
         <mat-label>Categoría (ID) *</mat-label>
         <input
           matInput
           formControlName="categoriaId"
           placeholder="Ingresa ID de categoría"
         />
         <mat-error *ngIf="categoriaIdCtrl?.hasError('required')">
           El ID de categoría es obligatorio.
         </mat-error>
         <mat-error *ngIf="categoriaIdCtrl?.hasError('invalidInteger')">
           Ingresa un entero válido.
         </mat-error>
       </mat-form-field>

        <!-- Precio Venta Actual -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Precio Venta Actual *</mat-label>
          <input
            matInput
            formControlName="precioVentaActual"
            placeholder="0.00"
            (blur)="onBlurFormatDecimal('precioVentaActual')"
            (focus)="onFocusRawDecimal('precioVentaActual')"
          />
          <mat-error *ngIf="precioVentaActualCtrl?.hasError('required')">
            El precio actual es obligatorio.
          </mat-error>
          <mat-error *ngIf="precioVentaActualCtrl?.hasError('invalidDecimal')">
            Ingresa un número válido (dos decimales max.).
          </mat-error>
        </mat-form-field>
      </div>

      <!-- 4) Fila: Precio Venta Anterior (DECIMAL) | Referencia -->
      <div class="row">
        <!-- Precio Venta Anterior -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Precio Venta Anterior</mat-label>
          <input
            matInput
            formControlName="precioVentaAnterior"
            placeholder="0.00"
            (blur)="onBlurFormatDecimal('precioVentaAnterior')"
            (focus)="onFocusRawDecimal('precioVentaAnterior')"
          />
          <mat-error *ngIf="form.hasError('precioAnteriorMayor')">
            El precio anterior no puede ser mayor que el actual.
          </mat-error>
        </mat-form-field>

        <!-- Referencia -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Referencia *</mat-label>
          <input matInput formControlName="referencia" placeholder="REFXXX" />
          <mat-error *ngIf="referenciaCtrl?.hasError('required')">
            La referencia es obligatoria.
          </mat-error>
        </mat-form-field>
      </div>

      <!-- 5) Fila: Stock Máximo (ENTERO) | Tiene IVA -->
      <div class="row">
        <!-- Stock Máximo -->
        <mat-form-field appearance="fill" class="form-field">
          <mat-label>Stock Máximo *</mat-label>
          <input
            matInput
            formControlName="stockMaximo"
            placeholder="0"
            (blur)="onBlurFormatInteger('stockMaximo')"
            (focus)="onFocusRawInteger('stockMaximo')"
          />
          <mat-error *ngIf="stockMaximoCtrl?.hasError('required')">
            El stock máximo es obligatorio.
          </mat-error>
          <mat-error *ngIf="stockMaximoCtrl?.hasError('invalidInteger')">
            Ingresa un entero válido (sin decimales).
          </mat-error>
        </mat-form-field>

        <!-- Tiene IVA -->
        <div class="form-field checkbox-field">
          <mat-checkbox formControlName="tieneIva">Tiene IVA</mat-checkbox>
        </div>
      </div>

      <!-- 6) Fila completa: Foto Producto (input file) -->
      <div class="row full-width-row">
        <label class="file-label">Foto Producto:</label>
        <input
          type="file"
          (change)="onFileSelected($event)"
          accept="image/*"
        />
      </div>

      <!-- Previsualización de la imagen -->
      <div class="row full-width-row" *ngIf="form.value.fotoProducto">
        <img
          [src]="form.value.fotoProducto"
          alt="Previsualización"
          class="preview-image"
        />
      </div>

      <!-- 7) Fila de botones al final (alineados a la derecha) -->
      <div class="button-row">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="form.invalid"
        >
          <mat-icon>save</mat-icon>
          Guardar
        </button>
        <button mat-button type="button" (click)="cancel()">
          Cancelar
        </button>
      </div>
    </form>
  </mat-card-content>
</mat-card>
